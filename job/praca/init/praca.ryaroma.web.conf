# This file is managed by ansible, don't make changes here - they will be overwritten.

map $http_cookie $isDevHack {
    default "";
    ~DEVELOPER_ACCESS=xxxZ7 "/non-existed-location";
}
map "$scheme:$request_method:$request_uri" $redirect {
    default YES;
    ~^((http:POST:.*)|(https:.*:.*)|(.*:.*:/files/.*))$ NO;
}

limit_req_zone $binary_remote_addr zone=rcsps:20m rate=40r/s;
limit_req_zone $binary_remote_addr zone=rcsps_dyn:20m rate=20r/s;

server {
    listen 80;
    listen 443 ssl;
    server_name praca.ryaroma.web www.praca.ryaroma.web;

    root /home/gutsout/h/praca-portal/public;
    index index.html index.php;
    client_max_body_size 20M;

    # SSL
    #ssl_certificate      /etc/nginx/ssl/praca-dev.web.crt;
    #ssl_certificate_key  /etc/nginx/ssl/praca-dev.web.key;
    ssl_certificate /etc/ssl/cert.crt;
    ssl_certificate_key /etc/ssl/cert.key;
    ssl_prefer_server_ciphers on;
    ssl_session_timeout  5m;
    ssl_protocols        TLSv1 TLSv1.1 TLSv1.2;
    ssl_ciphers          HIGH:!aNULL:!MD5;

    access_log /var/log/nginx/praca/access.log;
    error_log  /var/log/nginx/praca/error.log;

    # Only requests to our Host are allowed
    if ($host !~ ^(praca.ryaroma.web|www.praca.ryaroma.web)$ ) {
       return 444;
    }

    # Redirect www to nowww
    if ($host = 'www.praca.ryaroma.web') {
       return 301 https://praca.ryaroma.web$request_uri;
    }

    # Redirect to HTTPS
    if ($redirect = YES) {
       return 301 https://$host$request_uri;
    }

    # include /etc/nginx/includes/phpmyadmin.conf;
    # include /etc/nginx/includes/letsencrypt.conf;

    # Example HTTP Basic Authentication
    # auth_basic "Restricted";
    # auth_basic_user_file /etc/nginx/htpasswd;

    # Locations

    location / {
       fastcgi_param APPLICATION_ENV development;
       if (-f $isDevHack/h/pracaby/maintenance) {
         return 503;
       }
       rewrite ^([^.]*[^/])$ $1/ permanent;
       try_files $uri $uri/ /index.php?$args;
    }

    # Rewrite min js and min css
    location ~* (.+\.min)\..+\.(js|css)$ {
       try_files $uri $1.$2;
    }

    # Websocket (php daemon praca-notify-websocket)
    location /ws/ {
       proxy_pass http://127.0.0.1:8080;
       proxy_set_header X-Real-IP $remote_addr;
       proxy_http_version 1.1;
       proxy_set_header Upgrade $http_upgrade;
       proxy_set_header Connection "upgrade";
       proxy_set_header Proxy "";
    }

    # Main
    location ~ \.php {
       fastcgi_param APPLICATION_ENV development;
       fastcgi_pass  unix:/run/php/php7.1-fpm.sock;
       fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
       include fastcgi_params;
    }

    # HTTP File Server
    location = /file-server/praca.php {
       root /h/pracaby/http-file-server/;
       fastcgi_pass  unix:/run/php/php7.1-fpm.sock;
       fastcgi_param SCRIPT_FILENAME /h/pracaby/http-file-server/praca.php;
       include fastcgi_params;
    }

    location /files/ {
       alias /h/pracaby/http-file-server/praca/;
       expires 30d;
    }

    location /pictures/ {
       alias /h/pracaby/http-file-server/praca/;
       expires 30d;
    }

    location /img/ {
       expires 30d;
    }

    location ~* \.(js|css)$ {
       expires 30d;
    }

    location ~* \.(tpl|log|ht)$ {
       deny all;
    }

    # Errors
    error_page 503 @maintenance;
    location @maintenance {
       rewrite ^(.*)$ /maintenance-mode.html break;
    }

    location /error_pages_internal/ {
       alias /home/gutsout/h/praca-portal/template/error-pages/;
       allow all;
       internal;
    }

    error_page 400 /error_pages_internal/400.html;
    error_page 401 /error_pages_internal/401.html;
    error_page 403 /error_pages_internal/403.html;
    error_page 404 /error_pages_internal/404.html;
    error_page 408 /error_pages_internal/408.html;
    error_page 413 /error_pages_internal/413.html;
    error_page 414 /error_pages_internal/414.html;
    error_page 429 /error_pages_internal/429.html;
    error_page 431 /error_pages_internal/431.html;
    error_page 500 /error_pages_internal/500.html;
    error_page 502 /error_pages_internal/502.html;
    error_page 503 /error_pages_internal/503.html;
    error_page 504 /error_pages_internal/504.html;

## test start
## test end

}